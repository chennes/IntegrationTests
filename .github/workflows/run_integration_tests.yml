# SPDX-License-Identifier: LGPL-2.1-or-later

# This is a build and test workflow for the integration test suite of FreeCAD

name: Integration Test Suite

on:
  workflow_dispatch:
  schedule:
    # Run every day at 1am
    - cron: "0 1 * * *"

jobs:
  build_with_pixi:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      CCACHE_COMPRESS: true
      CCACHE_COMPRESSLEVEL: 5
      CCACHE_CONFIGPATH: ${{ github.workspace }}/ccache/config
      CCACHE_DIR: ${{ github.workspace }}/ccache
      CCACHE_MAXSIZE: 1G
      CCACHE_NODIRECT: true
      CCACHE_NOHASHDIR: true
      CCACHE_NOINODECACHE: true
      CCACHE_SLOPPINESS: "include_file_ctime,include_file_mtime,pch_defines,time_macros"
      builddir: ${{ github.workspace }}/build/release/
      cacheKey: pixi-ubuntu-latest
      config: release
      logdir: ${{ github.workspace }}/logs/

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - name: Set Platform Environment Variables
      shell: bash -l {0}
      env:
        OPERATING_SYSTEM: ${{ runner.os }}
      run: |
        if [[ $OPERATING_SYSTEM == 'Windows' ]]; then
          echo 'CCACHE_COMPILERCHECK=%compiler%' >> "$GITHUB_ENV"
        else
          echo 'CCACHE_COMPILERCHECK=%compiler% -dumpfullversion -dumpversion' >> "$GITHUB_ENV"
        fi

    - name: Checkout FreeCAD
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 2
        submodules: recursive
        path: FreeCAD
        ref: main
        repository: FreeCAD/FreeCAD

    - name: Checkout Integration Tests
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        path: IntegrationTests

    - name: Make needed directories, files and initializations
      id: Init
      run: |
        mkdir -p ${{ env.builddir }}
        mkdir -p ${{ env.logdir }}

    - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
      with:
        pixi-version: v0.59.0
        cache: false
        manifest-path: ${{ github.workspace }}/FreeCAD/pixi.toml

    - name: Restore Compiler Cache
      id: cache-restore
      if: always()
      uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ${{ env.CCACHE_DIR }}
        key: FC-${{ env.cacheKey }}-${{ github.ref }}-${{ github.run_id }}
        restore-keys: |
          FC-${{ env.cacheKey }}-${{ github.ref }}-
          FC-${{ env.cacheKey }}-

    - name: CMake Configure
      run: |
        cd ${{ github.workspace }}/FreeCAD
        pixi run configure-${{ env.config }}

    - name: CMake Build
      run: |
        cd ${{ github.workspace }}/FreeCAD
        pixi run build-${{ env.config }}

    - name: FreeCAD Integration Tests
      id: integration_tests
      if: always()
      run: |
        set +e
        cd ${{ github.workspace }}
        python3 IntegrationTests/Scripts/RunIntegrationTests.py --freecad FreeCAD/build/${{ env.config }}/bin/FreeCADCmd --script IntegrationTests/Scripts/EvaluateFile.FCMacro --fcstd-dir IntegrationTests/Data/CADFiles/ --baseline-dir IntegrationTests/Data/BaselineResults/ --verbose
        rc=$?
        echo "exit_code=$rc" >> "$GITHUB_OUTPUT"
        echo "Integration test exit code: $rc"

    - name: Open issue on failure
      if: always() && steps.integration_tests.outputs.exit_code != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `FreeCAD integration tests failed (${process.env.GITHUB_REF_NAME})`;
          const body = [
            `Run: https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
            `Exit code: ${{ steps.integration_tests.outputs.exit_code }}`,
          ].join('\n');
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title,
            body
          });

    - name: Save Compiler Cache
      id: cache-save
      if: always()
      uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ${{ env.CCACHE_DIR }}
        key: FC-${{ env.cacheKey }}-${{ github.ref }}-${{ github.run_id }}
